name: Deploy

on:
  push:
    branches: [ develop ]
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Determine deployment environment
  setup:
    name: Setup Deployment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      should_deploy: ${{ steps.set-env.outputs.should_deploy }}

    steps:
      - name: Determine environment
        id: set-env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

  # Run migrations before deployment
  migrate:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.should_deploy == 'true'
    environment: ${{ needs.setup.outputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: Run migrations
        working-directory: ./backend
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          NODE_ENV: ${{ needs.setup.outputs.environment }}
        run: |
          if [ -d "migrations" ]; then
            echo "Running database migrations..."
            npm run migrate || echo "No migrations to run"
          else
            echo "No migrations directory found, skipping..."
          fi

  # Deploy to Docker-based hosting (e.g., DigitalOcean, AWS ECS, etc.)
  deploy-docker:
    name: Deploy Docker Images
    runs-on: ubuntu-latest
    needs: [setup, migrate]
    if: needs.setup.outputs.should_deploy == 'true'
    environment:
      name: ${{ needs.setup.outputs.environment }}
      url: ${{ steps.set-url.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=${{ needs.setup.outputs.environment }}-

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          target: production

      - name: Extract metadata for frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=${{ needs.setup.outputs.environment }}-

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          target: production
          build-args: |
            VITE_API_URL=${{ secrets.VITE_API_URL }}

      - name: Set deployment URL
        id: set-url
        run: |
          if [ "${{ needs.setup.outputs.environment }}" == "production" ]; then
            echo "url=${{ secrets.PRODUCTION_URL }}" >> $GITHUB_OUTPUT
          else
            echo "url=${{ secrets.STAGING_URL }}" >> $GITHUB_OUTPUT
          fi

  # Optional: Deploy to cloud provider
  # Uncomment and configure based on your hosting provider

  # deploy-aws:
  #   name: Deploy to AWS ECS
  #   runs-on: ubuntu-latest
  #   needs: [setup, deploy-docker]
  #   if: needs.setup.outputs.should_deploy == 'true'
  #   environment: ${{ needs.setup.outputs.environment }}
  #
  #   steps:
  #     - name: Configure AWS credentials
  #       uses: aws-actions/configure-aws-credentials@v4
  #       with:
  #         aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
  #         aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  #         aws-region: ${{ secrets.AWS_REGION }}
  #
  #     - name: Deploy to ECS
  #       run: |
  #         aws ecs update-service \
  #           --cluster ${{ secrets.ECS_CLUSTER }} \
  #           --service ${{ secrets.ECS_SERVICE }} \
  #           --force-new-deployment

  # deploy-digitalocean:
  #   name: Deploy to DigitalOcean
  #   runs-on: ubuntu-latest
  #   needs: [setup, deploy-docker]
  #   if: needs.setup.outputs.should_deploy == 'true'
  #   environment: ${{ needs.setup.outputs.environment }}
  #
  #   steps:
  #     - name: Install doctl
  #       uses: digitalocean/action-doctl@v2
  #       with:
  #         token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
  #
  #     - name: Deploy to App Platform
  #       run: |
  #         doctl apps create-deployment ${{ secrets.APP_ID }} --wait

  # deploy-vps:
  #   name: Deploy to VPS
  #   runs-on: ubuntu-latest
  #   needs: [setup, deploy-docker]
  #   if: needs.setup.outputs.should_deploy == 'true'
  #   environment: ${{ needs.setup.outputs.environment }}
  #
  #   steps:
  #     - name: Deploy via SSH
  #       uses: appleboy/ssh-action@v1.0.0
  #       with:
  #         host: ${{ secrets.SSH_HOST }}
  #         username: ${{ secrets.SSH_USERNAME }}
  #         key: ${{ secrets.SSH_PRIVATE_KEY }}
  #         script: |
  #           cd /opt/smart-todo-app
  #           docker-compose pull
  #           docker-compose up -d
  #           docker system prune -f

  # Health check after deployment
  health-check:
    name: Post-Deployment Health Check
    runs-on: ubuntu-latest
    needs: [setup, deploy-docker]
    if: needs.setup.outputs.should_deploy == 'true'

    steps:
      - name: Wait for deployment to stabilize
        run: sleep 30

      - name: Check backend health
        run: |
          if [ "${{ needs.setup.outputs.environment }}" == "production" ]; then
            URL="${{ secrets.PRODUCTION_URL }}"
          else
            URL="${{ secrets.STAGING_URL }}"
          fi

          echo "Checking health at $URL/health"

          for i in {1..10}; do
            if curl -f "$URL/health"; then
              echo "Health check passed!"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 10s..."
            sleep 10
          done

          echo "Health check failed after 10 attempts"
          exit 1

      - name: Run smoke tests
        run: |
          if [ "${{ needs.setup.outputs.environment }}" == "production" ]; then
            URL="${{ secrets.PRODUCTION_URL }}"
          else
            URL="${{ secrets.STAGING_URL }}"
          fi

          echo "Running smoke tests..."

          # Test API is responding
          curl -f "$URL/api/health" || exit 1

          echo "Smoke tests passed!"

  # Rollback on failure
  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [setup, health-check]
    if: failure() && needs.setup.outputs.should_deploy == 'true'
    environment: ${{ needs.setup.outputs.environment }}

    steps:
      - name: Notify rollback required
        run: |
          echo "::error::Deployment failed, manual rollback may be required"
          echo "Environment: ${{ needs.setup.outputs.environment }}"
          echo "Commit: ${{ github.sha }}"

      # Uncomment based on your hosting provider
      # - name: Rollback ECS service
      #   run: |
      #     aws ecs update-service \
      #       --cluster ${{ secrets.ECS_CLUSTER }} \
      #       --service ${{ secrets.ECS_SERVICE }} \
      #       --task-definition ${{ secrets.PREVIOUS_TASK_DEFINITION }}

  # Send deployment notifications
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [setup, deploy-docker, health-check]
    if: always() && needs.setup.outputs.should_deploy == 'true'

    steps:
      - name: Determine status
        id: status
        run: |
          if [ "${{ needs.health-check.result }}" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
            echo "emoji=✅" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
            echo "emoji=❌" >> $GITHUB_OUTPUT
          fi

      - name: Extract version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      # Uncomment to enable Slack notifications
      # - name: Send Slack notification
      #   uses: slackapi/slack-github-action@v1.24.0
      #   with:
      #     payload: |
      #       {
      #         "text": "${{ steps.status.outputs.emoji }} Deployment to ${{ needs.setup.outputs.environment }}",
      #         "blocks": [
      #           {
      #             "type": "section",
      #             "text": {
      #               "type": "mrkdwn",
      #               "text": "${{ steps.status.outputs.emoji }} *Deployment ${{ steps.status.outputs.status }}*\n*Environment:* ${{ needs.setup.outputs.environment }}\n*Version:* ${{ steps.version.outputs.version }}\n*Triggered by:* ${{ github.actor }}"
      #             }
      #           }
      #         ]
      #       }
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      # Uncomment to enable Discord notifications
      # - name: Send Discord notification
      #   uses: sarisia/actions-status-discord@v1
      #   if: always()
      #   with:
      #     webhook: ${{ secrets.DISCORD_WEBHOOK }}
      #     title: "Deployment to ${{ needs.setup.outputs.environment }}"
      #     description: |
      #       Status: ${{ steps.status.outputs.status }}
      #       Version: ${{ steps.version.outputs.version }}
      #       Triggered by: ${{ github.actor }}
      #     color: ${{ steps.status.outputs.status == 'success' && '0x00ff00' || '0xff0000' }}

      - name: Create deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ steps.status.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.setup.outputs.environment }}" == "production" ]; then
            echo "- **URL**: ${{ secrets.PRODUCTION_URL }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **URL**: ${{ secrets.STAGING_URL }}" >> $GITHUB_STEP_SUMMARY
          fi
